<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI –Æ—Ä–∏—Å—Ç - –í–ª–∞–¥–∏–º–∏—Ä –ú–∏–ª–ª–µ—Ä</title>
  <link href="./css/style.css" rel="stylesheet" />
  <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
  <script src="./js/chat.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #2c3e50;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      text-align: center;
    }
    
    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      color: #2c3e50;
    }
    
    .subtitle {
      font-size: 1.2em;
      margin-bottom: 30px;
      opacity: 0.8;
      color: #34495e;
    }
    
    .chat-container {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      padding: 30px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .avatar-section {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 30px;
      margin-top: 20px;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
      min-width: 250px;
      max-width: 300px;
    }
    
    .avatar-container {
      position: relative;
      width: 640px;
      height: 480px;
      background: rgba(0,0,0,0.05);
      border-radius: 15px;
      overflow: hidden;
      border: 2px solid rgba(0,0,0,0.1);
    }
    
    .chat-sidebar {
      width: 350px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      border: 1px solid rgba(0,0,0,0.1);
    }
    
    button {
      background: linear-gradient(45deg, #3498db, #2980b9);
      border: none;
      padding: 15px 25px;
      border-radius: 25px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      background: linear-gradient(45deg, #2980b9, #3498db);
    }
    
    button:disabled {
      background: rgba(149, 165, 166, 0.7);
      cursor: not-allowed;
      transform: none;
    }
    
    .status {
      padding: 15px;
      background: rgba(52, 152, 219, 0.1);
      border-radius: 10px;
      margin-top: 15px;
      font-size: 14px;
      color: #2c3e50;
      border: 1px solid rgba(52, 152, 219, 0.2);
    }
    
    .chat-sidebar {
      width: 300px;
      max-height: 600px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      border: 1px solid #e1e8ed;
    }
    
    .chat-sidebar h3 {
      margin-top: 0;
      color: #2c3e50;
      font-size: 18px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    
    .chat-history {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-height: 500px;
      overflow-y: auto;
      padding: 10px 0;
    }
    
    .chat-history::-webkit-scrollbar {
      width: 8px;
    }
    
    .chat-history::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    .chat-history::-webkit-scrollbar-thumb {
      background: #3498db;
      border-radius: 10px;
    }
    
    .chat-message {
      margin-bottom: 15px;
      padding: 12px;
      border-radius: 10px;
      max-width: 100%;
      word-wrap: break-word;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .message {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      line-height: 1.4;
    }
    
    .message.user {
      background: rgba(52, 152, 219, 0.1);
      border-left: 4px solid #3498db;
    }
    
    .message.assistant {
      background: rgba(46, 204, 113, 0.1);
      border-left: 4px solid #2ecc71;
    }
    
    .message strong {
      color: #2c3e50;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #2c3e50;
    }
    
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üèõÔ∏è AI –Æ—Ä–∏—Å—Ç</h1>
    <p class="subtitle">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –æ—Ç —Ñ–∏—Ä–º—ã –í–ª–∞–¥–∏–º–∏—Ä–∞ –ú–∏–ª–ª–µ—Ä–∞</p>
    
    <div class="chat-container">
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>–ó–∞–≥—Ä—É–∂–∞–µ–º AI —é—Ä–∏—Å—Ç–∞...</p>
      </div>
      
      <div class="avatar-section" id="mainContent" style="display: none;">
        <div class="controls">
          <button id="microphoneBtn" onclick="toggleMicrophone()">üé§ –ù–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä</button>
          <button id="stopSpeakingBtn" onclick="stopSpeaking()" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          <button id="clearHistoryBtn" onclick="clearChatHistory()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
          <div class="status" id="status">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            üí° –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: Ctrl+Space (–º–∏–∫—Ä–æ—Ñ–æ–Ω), Esc (–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ—á—å)
          </div>
        </div>
        
        <div class="avatar-container">
          <div id="remoteVideo" style="width: 100%; height: 100%;"></div>
          <div id="subtitles" style="position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; color: #2c3e50; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 10px; margin: 10px; font-weight: bold;" hidden></div>
        </div>
        
        <div class="chat-sidebar">
          <h3>üí¨ –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞</h3>
          <div id="chatHistory" class="chat-history"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    var speechRecognizer;
    var avatarSynthesizer;
    var peerConnection;
    var messages = [];
    var messageInitiated = false;
    var dataSources = [];
    var isSpeaking = false;
    var sessionActive = false;
    var isRecording = false;
    var config = {};

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = function() {
      document.getElementById('loading').style.display = 'block';
      loadConfigurationAndStart();
    };

    async function loadConfigurationAndStart() {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        const response = await fetch('/internal/config');
        config = await response.json();
        
        console.log('üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', config);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        const requiredParams = [
          'azure_speech_key',
          'azure_speech_region', 
          'azure_openai_key',
          'azure_openai_endpoint',
          'azure_openai_deployment',
          'azure_system_prompt',
          'voice_name',
          'stt_locale',
          'avatar_character',
          'avatar_style'
        ];
        
        const missingParams = requiredParams.filter(param => !config[param]);
        
        if (missingParams.length > 0) {
          console.error('‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:', missingParams);
          document.getElementById('loading').innerHTML = 
            `<p>‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:</p><ul>${missingParams.map(p => `<li>${p}</li>`).join('')}</ul><p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env</p>`;
          return;
        }
        
        console.log('‚úÖ –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Azure Search
        if (config.azure_search_endpoint && config.azure_search_api_key && config.azure_search_index_name) {
          console.log('‚úÖ Azure Search –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
        } else {
          console.log('‚ö†Ô∏è Azure Search –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω - –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ OpenAI');
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤–∞—Ç–∞—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        await startAvatarSession();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        document.getElementById('loading').style.display = 'none';
        document.getElementById('mainContent').style.display = 'flex';
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          if (sessionActive) {
            toggleMicrophone();
          }
        }, 2000);
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        document.getElementById('loading').innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>';
      }
    }

    async function startAvatarSession() {
      try {
        updateStatus('–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ AI —é—Ä–∏—Å—Ç—É...');
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Speech SDK
        const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(
          config.azure_speech_key, 
          config.azure_speech_region
        );
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞
        const avatarConfig = new SpeechSDK.AvatarConfig(
          config.avatar_character || 'lisa', 
          config.avatar_style || 'casual'
        );
        
        avatarSynthesizer = new SpeechSDK.AvatarSynthesizer(speechConfig, avatarConfig);
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
        const speechRecognitionConfig = SpeechSDK.SpeechConfig.fromEndpoint(
          new URL(`wss://${config.azure_speech_region}.stt.speech.microsoft.com/speech/universal/v2`),
          config.azure_speech_key
        );
        
        speechRecognitionConfig.setProperty(
          SpeechSDK.PropertyId.SpeechServiceConnection_LanguageIdMode,
          "Continuous"
        );
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        speechRecognitionConfig.setProperty(
          SpeechSDK.PropertyId.SpeechServiceConnection_EndSilenceTimeoutMs,
          "2000"  // 2 —Å–µ–∫—É–Ω–¥—ã —Ç–∏—à–∏–Ω—ã –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º
        );
        
        speechRecognitionConfig.setProperty(
          SpeechSDK.PropertyId.SpeechServiceConnection_InitialSilenceTimeoutMs,
          "10000"  // 10 —Å–µ–∫—É–Ω–¥ –æ–∂–∏–¥–∞–Ω–∏—è –Ω–∞—á–∞–ª–∞ —Ä–µ—á–∏
        );
        
        const sttLocales = [config.stt_locale];
        if (!sttLocales[0]) {
          console.error('‚ùå STT_LOCALE –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏');
          updateStatus('‚ùå –Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
          return;
        }
        const autoDetectSourceLanguageConfig = SpeechSDK.AutoDetectSourceLanguageConfig.fromLanguages(sttLocales);
        
        speechRecognizer = SpeechSDK.SpeechRecognizer.FromConfig(
          speechRecognitionConfig,
          autoDetectSourceLanguageConfig,
          SpeechSDK.AudioConfig.fromDefaultMicrophoneInput()
        );

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
        initMessages();
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ WebRTC
        await setupWebRTC();
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞:', error);
        updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        throw error;
      }
    }

    async function setupWebRTC() {
      try {
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
        const xhr = new XMLHttpRequest();
        xhr.open("GET", `https://${config.azure_speech_region}.tts.speech.microsoft.com/cognitiveservices/avatar/relay/token/v1`);
        xhr.setRequestHeader("Ocp-Apim-Subscription-Key", config.azure_speech_key);
        
        xhr.onload = function() {
          if (this.status === 200) {
            const responseData = JSON.parse(this.responseText);
            const iceServerUrl = responseData.Urls[0];
            const iceServerUsername = responseData.Username;
            const iceServerCredential = responseData.Password;
            
            connectAvatar(iceServerUrl, iceServerUsername, iceServerCredential);
          } else {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω');
          }
        };
        
        xhr.send();
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ WebRTC:', error);
        throw error;
      }
    }

    function connectAvatar(iceServerUrl, iceServerUsername, iceServerCredential) {
      peerConnection = new RTCPeerConnection({
        iceServers: [{
          urls: [iceServerUrl],
          username: iceServerUsername,
          credential: iceServerCredential
        }]
      });

      peerConnection.ontrack = (event) => {
        if (event.track.kind === 'audio') {
          let audioElement = document.createElement('audio');
          audioElement.id = 'audioPlayer';
          audioElement.srcObject = event.streams[0];
          audioElement.autoplay = true;
          
          const remoteDiv = document.getElementById('remoteVideo');
          [...remoteDiv.childNodes].forEach(node => {
            if (node.localName === 'audio') remoteDiv.removeChild(node);
          });
          remoteDiv.appendChild(audioElement);
          
        } else if (event.track.kind === 'video') {
          let videoElement = document.createElement('video');
          videoElement.id = 'videoPlayer';
          videoElement.srcObject = event.streams[0];
          videoElement.autoplay = true;
          videoElement.playsInline = true;
          videoElement.style.width = '100%';
          videoElement.style.height = '100%';
          videoElement.style.objectFit = 'cover';
          
          videoElement.onplaying = () => {
            console.log('–ê–≤–∞—Ç–∞—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω');
            const remoteDiv = document.getElementById('remoteVideo');
            [...remoteDiv.childNodes].forEach(node => {
              if (node.localName === 'video') remoteDiv.removeChild(node);
            });
            remoteDiv.appendChild(videoElement);
            
            sessionActive = true;
            updateStatus('‚úÖ AI —é—Ä–∏—Å—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
            
            // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            setTimeout(() => {
              speak('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø AI –ø–æ–º–æ—â–Ω–∏–∫ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ñ–∏—Ä–º—ã –í–ª–∞–¥–∏–º–∏—Ä–∞ –ú–∏–ª–ª–µ—Ä–∞. –ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å –≤–∞–º —Å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏. –ö–∞–∫ –¥–µ–ª–∞?');
            }, 1000);
          };
        }
      };

      peerConnection.addTransceiver('video', { direction: 'sendrecv' });
      peerConnection.addTransceiver('audio', { direction: 'sendrecv' });

      avatarSynthesizer.startAvatarAsync(peerConnection)
        .then(result => {
          if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
            console.log('–ê–≤–∞—Ç–∞—Ä –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ');
          } else {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞:', result);
            updateStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞');
          }
        })
        .catch(error => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞:', error);
          updateStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞');
        });
    }

    function initMessages() {
      messages = [];
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ Azure (–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è)
      const systemPrompt = config.azure_system_prompt;
      if (systemPrompt) {
        messages.push({ role: 'system', content: systemPrompt });
        console.log('–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ Azure:', systemPrompt.substring(0, 50) + '...');
      } else {
        console.error('–û–®–ò–ë–ö–ê: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Azure!');
        updateStatus('‚ùå –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
        return;
      }
      messageInitiated = true;
    }

    function toggleMicrophone() {
      const btn = document.getElementById('microphoneBtn');
      
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    }

    function startRecording() {
      if (!sessionActive) {
        updateStatus('‚ùå –ê–≤–∞—Ç–∞—Ä –Ω–µ –≥–æ—Ç–æ–≤');
        return;
      }
      
      isRecording = true;
      const btn = document.getElementById('microphoneBtn');
      btn.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
      btn.style.background = 'linear-gradient(45deg, #ff4757, #ff3838)';
      
      updateStatus('üé§ –°–ª—É—à–∞—é...');
      
      // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
      speechRecognizer.recognizing = (s, e) => {
        if (e.result.text) {
          updateStatus('üé§ –°–ª—É—à–∞—é: ' + e.result.text);
          console.log('üé§ –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ:', e.result.text);
        }
      };
      
      speechRecognizer.recognized = async (s, e) => {
        console.log('üé§ –°–æ–±—ã—Ç–∏–µ recognized:', e);
        console.log('üé§ Reason:', e.result.reason);
        console.log('üé§ Text:', e.result.text);
        
        if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
          const userQuery = e.result.text.trim();
          if (userQuery && userQuery.length > 2) {  // –ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞
            console.log('‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ:', userQuery);
            updateStatus('üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...');
            addChatMessage('–í—ã', userQuery);
            await handleUserQuery(userQuery);
          } else {
            console.log('‚ö†Ô∏è –ü—É—Å—Ç–æ–π –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å:', userQuery);
            updateStatus('üé§ –°–ª—É—à–∞—é... (—Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å)');
          }
        } else if (e.result.reason === SpeechSDK.ResultReason.NoMatch) {
          console.log('‚ùå –†–µ—á—å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ (NoMatch)');
          updateStatus('üé§ –°–ª—É—à–∞—é... (—Ä–µ—á—å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞)');
        } else {
          console.log('‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:', e.result.reason);
          updateStatus('üé§ –°–ª—É—à–∞—é... (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞)');
        }
      };
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
      speechRecognizer.canceled = (s, e) => {
        console.error('‚ùå –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ:', e);
        console.error('‚ùå –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã:', e.reason);
        console.error('‚ùå –ö–æ–¥ –æ—à–∏–±–∫–∏:', e.errorCode);
        console.error('‚ùå –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', e.errorDetails);
        
        updateStatus('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏');
        addChatMessage('–°–∏—Å—Ç–µ–º–∞', `–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ${e.errorDetails || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
        
        isRecording = false;
        const btn = document.getElementById('microphoneBtn');
        btn.textContent = 'üé§ –ù–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä';
        btn.style.background = 'linear-gradient(45deg, #3498db, #2980b9)';
      };
      
      speechRecognizer.startContinuousRecognitionAsync(() => {
        console.log('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞');
      }, (err) => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:', err);
        updateStatus('‚ùå –û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞');
        isRecording = false;
        btn.textContent = 'üé§ –ù–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä';
        btn.style.background = 'linear-gradient(45deg, #ff6b6b, #ffa500)';
      });
    }

    function stopRecording() {
      if (!isRecording) return;
      
      isRecording = false;
      const btn = document.getElementById('microphoneBtn');
      btn.textContent = 'üé§ –ù–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä';
      btn.style.background = 'linear-gradient(45deg, #ff6b6b, #ffa500)';
      
      updateStatus('‚èπÔ∏è –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
      
      speechRecognizer.stopContinuousRecognitionAsync(() => {
        console.log('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
      }, (err) => {
        console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–ø–∏—Å–∏:', err);
      });
    }

    async function handleUserQuery(userQuery) {
      try {
        console.log('üîÑ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–∞:', userQuery);
        updateStatus('ü§î –î—É–º–∞—é...');
        
        messages.push({ role: 'user', content: userQuery });
        console.log('üìù –î–æ–±–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é. –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π:', messages.length);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –Ω–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
        const requestBody = {
          messages: messages,
          stream: false,
          max_tokens: 500,
          temperature: 0.7
        };
        
        console.log('ÔøΩ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ /chat —ç–Ω–¥–ø–æ–∏–Ω—Ç...');
        const response = await fetch('/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });
        
        console.log('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç /chat. Status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('‚ùå –û—à–∏–±–∫–∞ HTTP:', response.status, response.statusText);
          console.error('‚ùå –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText}\n${errorText}`);
        }
        
        const data = await response.json();
        console.log('ÔøΩ –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
        
        if (data.status === 'success' && data.response) {
          const assistantReply = data.response;
          
          console.log('ü§ñ –û—Ç–≤–µ—Ç AI:', assistantReply);
          messages.push({ role: 'assistant', content: assistantReply });
          
          addChatMessage('AI –Æ—Ä–∏—Å—Ç', assistantReply);
          speak(assistantReply);
          
        } else {
          throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
        }
        
      } catch (error) {
        console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ handleUserQuery:', error);
        console.error('‚ùå –°—Ç–µ–∫ –æ—à–∏–±–∫–∏:', error.stack);
        updateStatus('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞');
        addChatMessage('–°–∏—Å—Ç–µ–º–∞', `–û—à–∏–±–∫–∞: ${error.message}`);
        speak('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
      }
    }

    function speak(text) {
      if (!avatarSynthesizer) return;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–±–∏–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      setTimeout(() => {
        updateStatus('üí¨ –ì–æ–≤–æ—Ä—é...');
        
        const voiceName = config.voice_name;
        if (!voiceName) {
          console.error('‚ùå VOICE_NAME –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏');
          updateStatus('‚ùå –ì–æ–ª–æ—Å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
          return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º SSML –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ä–µ—á–∏
        const ssml = `<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xml:lang='${config.stt_locale || 'ru-RU'}'>
                        <voice name='${voiceName}'>
                          <prosody rate='1.1'>
                            ${text}
                          </prosody>
                        </voice>
                      </speak>`;
        
        avatarSynthesizer.speakSsmlAsync(ssml)
          .then(() => {
            updateStatus('‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
          })
          .catch(error => {
            console.error('–û—à–∏–±–∫–∞ —Ä–µ—á–∏:', error);
            updateStatus('‚ùå –û—à–∏–±–∫–∞ —Ä–µ—á–∏');
          });
      }, 500); // –ó–∞–¥–µ—Ä–∂–∫–∞ 500ms —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–±–∏–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    }

    function stopSpeaking() {
      if (avatarSynthesizer) {
        avatarSynthesizer.stopSpeakingAsync();
        updateStatus('‚èπÔ∏è –†–µ—á—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
      }
    }

    function clearChatHistory() {
      document.getElementById('chatHistory').innerHTML = '';
      initMessages();
      updateStatus('üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
    }

    function addChatMessage(sender, message) {
      const chatHistory = document.getElementById('chatHistory');
      const messageElement = document.createElement('div');
      messageElement.className = 'chat-message';
      
      if (sender === '–í—ã') {
        messageElement.style.background = '#e3f2fd';
        messageElement.style.borderLeft = '4px solid #2196f3';
        messageElement.style.marginLeft = '20px';
      } else {
        messageElement.style.background = '#f3e5f5';
        messageElement.style.borderLeft = '4px solid #9c27b0';
        messageElement.style.marginRight = '20px';
      }
      
      messageElement.innerHTML = `
        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">${sender}</div>
        <div style="color: #2c3e50;">${message}</div>
      `;
      
      chatHistory.appendChild(messageElement);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    window.addEventListener('error', (event) => {
      console.error('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', event.error);
      updateStatus('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    document.addEventListener('keydown', (event) => {
      if (event.code === 'Space' && event.ctrlKey) {
        event.preventDefault();
        toggleMicrophone();
      }
      if (event.code === 'Escape') {
        event.preventDefault();
        stopSpeaking();
      }
    });
  </script>
</body>
</html>
